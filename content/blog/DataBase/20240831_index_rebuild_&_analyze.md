---
title: '[성능개선] index rebuild vs analyze'
date: 2024-08-31 18:30
category: 'Database/SQL'
draft: false
tags:
    - SQL
    - workLog
---

> 이전에 말했던 oracle -> postgresql로 이관하는 모 고객사에서, 메인테이블(6천만건 이상) 관련 조회쿼리가 전반적으로 느리다고 지원요청을 받아 분석하게 되었다.  
> 이관 후에 통계정보를 업데이트(analyze) 해보라고 전달했는데 그래도 느리다고 해서 의아했다.
> 직접 개발계에 원격을 붙어 분석하면서 분포도가 나쁜 인덱스를 선택하거나, 비교적 간단한 조회문에도 느리게 잡혀서 해당 테이블에 analyze를 날려봤더니 정상속도를 되찾았다.
> 알고보니, 유지보수 팀에서 데이터 이관 후 index를 생성했기 때문에 통계정보를 업데이트 하지 않아도 될거라 판단한 것.

나도 index rebuild가 통계정보를 업데이트하는 것과 비슷한 맥락이라 생각했던 지라 정확한 차이를 알기위해 GPT한테 물어봤다.

---
*요약 :* Index Drop 및 재생성은 인덱스 자체의 재구성을 통해 성능을 직접적으로 개선하는 반면, ANALYZE는 테이블의 데이터 통계를 수집하여 옵티마이저가 더 나은 결정을 내릴 수 있도록 돕습니다.  <br/>
**`Index 재생성`**은 `데이터 액세스 효율성을 향상시키기 위한` **`구조적 변화`**이며,  
**`ANALYZE`**는 **`옵티마이저의 지능을 높여`** `더 나은 쿼리 실행 계획을 수립`하게 합니다.  <br/>

---


### Q1. index를 drop후 새로잡는것과 테이블 analyze하는것은 어떤차이가있지?


INDEX DROP 및 재생성과 테이블 ANALYZE는 데이터베이스 성능 최적화에서 매우 중요한 역할을 하지만, 그 기능과 목적은 서로 다릅니다.
#### 1. Index Drop 및 재생성   
* 목적 : 인덱스를 삭제하고 다시 생성하는 것은 주로 다음의 상황에서 이루어집니다
    * 데이터 재구조화: 테이블의 데이터가 많이 변경되어 기존 인덱스가 비효율적이거나, 인덱스의 통계가 최신 상태가 아니어서 성능이 저하된 경우.
    * 인덱스 정리: 시간이 지나면서 인덱스가 단편화되거나 비효율적으로 변할 수 있습니다. 이럴 경우 인덱스를 드롭하고 새로 생성하면 성능이 개선될 수 있습니다.
    * 인덱스 설계 변경: 기존의 인덱스가 최적화되지 않아서, 새로운 컬럼을 포함하거나 순서를 바꾸기 위해 인덱스를 다시 설정하는 경우.
* 효과:
    * 재정렬: 인덱스를 드롭하고 재생성하면 인덱스 데이터가 새로 정렬되고 구성되며, 이는 인덱스 접근 속도를 개선할 수 있습니다.
    * 단편화 해소: 오래된 인덱스의 단편화를 해결하고 새로운 데이터에 맞춰 최적화된 인덱스를 얻을 수 있습니다.
#### 2. ANALYZE  
* 목적:
    * ANALYZE 명령어는 테이블의 통계를 수집하여 데이터베이스 옵티마이저가 최적의 쿼리 실행 계획을 수립할 수 있도록 돕습니다. 특히, 데이터 분포, NULL 비율, 레코드 수 등의 정보를 수집합니다.
* 효과:
    * 최적화된 쿼리 플랜 생성: 옵티마이저는 테이블과 인덱스의 최신 통계에 따라 가장 효율적인 실행 계획을 선택합니다. 따라서, 쿼리 성능이 향상될 수 있습니다.
    * 통계 정보 갱신: 테이블의 데이터가 변하면서 발생하는 데이터 분포의 변화를 반영하여 통계 정보를 최신 상태로 유지합니다.

### Q2. index를 drop하고 다시 생성하는 과정에서 analyze작업을 포함하진 않아?

#### 인덱스를 드롭하고 다시 생성하는 과정에서 자동으로 ANALYZE 작업이 수행되지는 않습니다.

* 세부 사항:
    * 인덱스 생성: 인덱스를 다시 생성할 때, 데이터베이스는 해당 인덱스를 최적화하고 정렬하여 쿼리 성능을 향상시킵니다. 이 과정은 인덱스 자체에 대한 작업이며, 테이블의 데이터에 대한 통계 정보를 갱신하는 과정은 포함되지 않습니다.

* ANALYZE 필요성: 인덱스를 새로 생성한 후에는, 테이블에 대한 통계 정보가 최신 상태로 갱신되지 않기 때문에, 옵티마이저가 최적의 쿼리 실행 계획을 선택하는 데 문제가 발생할 수 있습니다. 따라서 인덱스를 재생성한 후에 ANALYZE를 실행하는 것이 권장됩니다. 이는 데이터베이스가 테이블과 인덱스에 대한 최신 통계 정보를 수집하고, 이를 바탕으로 더 나은 쿼리 계획을 세울 수 있도록 돕기 위함입니다.

* 요약:
    * 인덱스를 드롭하고 다시 생성하는 작업 자체는 ANALYZE를 포함하지 않으며, 별도로 ANALYZE 명령어를 실행해야 합니다.
    * 인덱스를 재생성한 후에는 테이블에 대해 ANALYZE를 수행하는 것이 좋습니다. 이는 최신 통계 정보를 데이터베이스에 제공하여 성능을 최적화할 수 있기 때문입니다.

--- 

오늘도 하나 배워갑니다.😀